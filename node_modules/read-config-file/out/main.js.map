{"version":3,"file":"main.js","sourceRoot":"","sources":["../src/main.ts"],"names":[],"mappings":"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","sourcesContent":["import { readFile, readJson } from \"fs-extra-p\"\nimport { safeLoad } from \"js-yaml\"\nimport * as path from \"path\"\nimport { deepAssign } from \"./deepAssign\"\nimport { Lazy } from \"lazy-val\"\nimport Ajv, { ErrorObject } from \"ajv\"\nimport { normaliseErrorMessages } from \"./ajvErrorNormalizer\"\nimport { parse as parseEnv } from \"dotenv\"\n\nexport async function readConfig<T>(configFile: string, projectDir?: string, log?: (message: string) => void): Promise<T> {\n  const data = await readFile(configFile, \"utf8\")\n  let result\n  if (configFile.endsWith(\".json5\") || configFile.endsWith(\".json\")) {\n    result = require(\"json5\").parse(data)\n  }\n  else if (configFile.endsWith(\".toml\")) {\n    result = require(\"toml\").parse(data)\n  }\n  else {\n    result = safeLoad(data)\n  }\n\n  if (log != null && projectDir != null) {\n    const relativePath = path.relative(projectDir, configFile)\n    log(`Using ${relativePath.startsWith(\"..\") ? configFile : relativePath} configuration file`)\n  }\n  return result\n}\n\nexport async function findAndReadConfig<T>(request: ReadConfigRequest): Promise<T | null> {\n  const prefix = request.configFilename\n  for (const configFile of [`${prefix}.yml`, `${prefix}.yaml`, `${prefix}.json`, `${prefix}.json5`, `${prefix}.toml`]) {\n    const data = await orNullIfFileNotExist<T>(readConfig(path.join(request.projectDir, configFile), request.projectDir, request.log))\n    if (data != null) {\n      return data\n    }\n  }\n\n  return null\n}\n\nexport function orNullIfFileNotExist<T>(promise: Promise<T>): Promise<T | null> {\n  return orIfFileNotExist(promise, null)\n}\n\nexport function orIfFileNotExist<T>(promise: Promise<T>, fallbackValue: T): Promise<T> {\n  return promise\n    .catch(e => {\n      if (e.code === \"ENOENT\" || e.code === \"ENOTDIR\") {\n        return fallbackValue\n      }\n      throw e\n    })\n}\n\nexport interface ReadConfigRequest {\n  packageKey: string\n  configFilename: string\n\n  projectDir: string\n  packageMetadata: Lazy<{ [key: string]: any } | null> | null\n\n  log?: (message: string) => void\n}\n\nexport async function loadConfig<T>(request: ReadConfigRequest): Promise<T | null> {\n  let packageMetadata = request.packageMetadata == null ? null : await request.packageMetadata.value\n  if (packageMetadata == null) {\n    packageMetadata = await orNullIfFileNotExist(readJson(path.join(request.projectDir, \"package.json\")))\n  }\n  const data = packageMetadata == null ? null : packageMetadata[request.packageKey]\n  return data == null ? findAndReadConfig<T>(request) : data\n}\n\nexport async function getConfig<T>(request: ReadConfigRequest, configPath?: string | null, configFromOptions?: T | null): Promise<T> {\n  let fileOrPackageConfig: T | null\n  if (configPath == null) {\n    fileOrPackageConfig = await loadConfig<T>(request)\n  }\n  else {\n    fileOrPackageConfig = await readConfig<T>(path.resolve(request.projectDir, configPath), request.projectDir, request.log)\n  }\n\n  return deepAssign(fileOrPackageConfig == null ? Object.create(null) : fileOrPackageConfig, configFromOptions)\n}\n\nexport async function loadParentConfig<T>(request: ReadConfigRequest, spec: string): Promise<T> {\n  let isFileSpec: boolean | undefined\n  if (spec.startsWith(\"file:\")) {\n    spec = spec.substring(\"file:\".length)\n    isFileSpec = true\n  }\n\n  let parentConfig = await orNullIfFileNotExist(readConfig<T>(path.resolve(request.projectDir, spec), request.projectDir, request.log))\n  if (parentConfig == null && isFileSpec !== true) {\n    let resolved: string | null = null\n    try {\n      resolved = require.resolve(spec)\n    }\n    catch (e) {\n      // ignore\n    }\n\n    if (resolved != null) {\n      parentConfig = await readConfig<T>(resolved, request.projectDir, request.log)\n    }\n  }\n\n  if (parentConfig == null) {\n    throw new Error(`Cannot find parent config file: ${spec}`)\n  }\n\n  return parentConfig\n}\n\nexport async function validateConfig(config: any, scheme: Lazy<any>, errorMessage: (error: string, errors: Array<ErrorObject>) => string) {\n  const ajv = new Ajv({\n    allErrors: true,\n    coerceTypes: true,\n    verbose: true,\n    errorDataPath: \"configuration\",\n  })\n  ajv.addMetaSchema(require(\"ajv/lib/refs/json-schema-draft-04.json\"))\n  require(\"ajv-keywords\")(ajv, [\"typeof\"])\n  const schema = await scheme.value\n  const validator = ajv.compile(schema)\n\n  if (!validator(config)) {\n    throw new Error(errorMessage(normaliseErrorMessages(validator.errors!, schema), validator.errors!!))\n  }\n}\n\nexport async function loadEnv(envFile: string) {\n  const data = await orNullIfFileNotExist(readFile(envFile, \"utf8\"))\n  if (data == null) {\n    return null\n  }\n\n  const parsed = parseEnv(data)\n  for (const key of Object.keys(parsed)) {\n    if (!process.env.hasOwnProperty(key)) {\n      process.env[key] = parsed[key]\n    }\n  }\n  require(\"dotenv-expand\")(parsed)\n  return parsed\n}"]}
