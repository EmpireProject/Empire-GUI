{"version":3,"file":"dirPackager.js","sourceRoot":"","sources":["../../src/packager/dirPackager.ts"],"names":[],"mappings":"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","sourcesContent":["import { path7za } from \"7zip-bin\"\nimport BluebirdPromise from \"bluebird-lst\"\nimport { debug7zArgs, log, spawn, exec, isEnvTrue} from \"builder-util\"\nimport { copyDir, DO_NOT_USE_HARD_LINKS, statOrNull } from \"builder-util/out/fs\"\nimport { chmod, emptyDir } from \"fs-extra-p\"\nimport * as path from \"path\"\nimport { Configuration, ElectronDownloadOptions } from \"../configuration\"\nimport { PlatformPackager } from \"../platformPackager\"\n\nconst downloadElectron: (options: any) => Promise<any> = BluebirdPromise.promisify(require(\"electron-download-tf\"))\n\ninterface InternalElectronDownloadOptions extends ElectronDownloadOptions {\n  version: string\n  platform: string\n  arch: string\n}\n\nfunction createDownloadOpts(opts: Configuration, platform: string, arch: string, electronVersion: string): InternalElectronDownloadOptions {\n  return {\n    platform,\n    arch,\n    version: electronVersion, ...opts.electronDownload\n  }\n}\n\n/** @internal */\nexport function unpackElectron(packager: PlatformPackager<any>, out: string, platform: string, arch: string, version: string) {\n  return unpack(packager, out, platform, createDownloadOpts(packager.config, platform, arch, version))\n}\n\n/** @internal */\nexport function unpackMuon(packager: PlatformPackager<any>, out: string, platform: string, arch: string, version: string) {\n  return unpack(packager, out, platform, {\n    mirror: \"https://github.com/brave/muon/releases/download/v\",\n    customFilename: `brave-v${version}-${platform}-${arch}.zip`,\n    verifyChecksum: false, ...createDownloadOpts(packager.config, platform, arch, version)\n  })\n}\n\nasync function unpack(packager: PlatformPackager<any>, out: string, platform: string, options: InternalElectronDownloadOptions) {\n  let dist: string | null | undefined = packager.config.electronDist\n  if (dist != null) {\n    const zipFile = `electron-v${options.version}-${platform}-${options.arch}.zip`\n    const resolvedDist = path.resolve(packager.projectDir, dist)\n    if ((await statOrNull(path.join(resolvedDist, zipFile))) != null) {\n      options.cache = resolvedDist\n      dist = null\n    }\n  }\n\n  if (dist == null) {\n    const zipPath = (await BluebirdPromise.all<any>([\n      downloadElectron(options),\n      emptyDir(out)\n    ]))[0]\n\n    if (process.platform === \"darwin\" || isEnvTrue(process.env.USE_UNZIP)) {\n      // on mac unzip faster than 7za (1.1 sec vs 1.6 see)\n      await exec(\"unzip\", [\"-oqq\", \"-d\", out, zipPath])\n    }\n    else {\n      await spawn(path7za, debug7zArgs(\"x\").concat(zipPath, \"-aoa\", `-o${out}`))\n      if (platform === \"linux\") {\n        // https://github.com/electron-userland/electron-builder/issues/786\n        // fix dir permissions â€” opposite to extract-zip, 7za creates dir with no-access for other users, but dir must be readable for non-root users\n        await BluebirdPromise.all([\n          chmod(path.join(out, \"locales\"), \"0755\"),\n          chmod(path.join(out, \"resources\"), \"0755\")\n        ])\n      }\n    }\n  }\n  else {\n    const source = packager.getElectronSrcDir(dist)\n    const destination = packager.getElectronDestinationDir(out)\n    log(`Copying Electron from \"${source}\" to \"${destination}\"`)\n    await emptyDir(out)\n    await copyDir(source, destination, {\n      isUseHardLink: DO_NOT_USE_HARD_LINKS,\n    })\n  }\n}"]}
