{"version":3,"file":"updateUnfoBuilder.js","sourceRoot":"","sources":["../../src/publish/updateUnfoBuilder.ts"],"names":[],"mappings":"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","sourcesContent":["import { hashFile, Arch, serializeToYaml, safeStringifyJson } from \"builder-util\"\nimport { GenericServerOptions, PublishConfiguration, UpdateInfo, GithubOptions, WindowsUpdateInfo } from \"builder-util-runtime\"\nimport { outputFile, outputJson, readFile } from \"fs-extra-p\"\nimport { Lazy } from \"lazy-val\"\nimport * as path from \"path\"\nimport { ReleaseInfo } from \"../configuration\"\nimport { Platform } from \"../core\"\nimport { ArtifactCreated } from \"../packagerApi\"\nimport { PlatformPackager } from \"../platformPackager\"\nimport { computeDownloadUrl, getPublishConfigsForUpdateInfo } from \"./PublishManager\"\nimport * as semver from \"semver\"\nimport { MacConfiguration } from \"../\"\nimport BluebirdPromise from \"bluebird-lst\"\nimport { Packager } from \"../packager\"\n\nasync function getReleaseInfo(packager: PlatformPackager<any>) {\n  const releaseInfo: ReleaseInfo = {...(packager.platformSpecificBuildOptions.releaseInfo || packager.config.releaseInfo)}\n  if (releaseInfo.releaseNotes == null) {\n    const releaseNotesFile = await packager.getResource(releaseInfo.releaseNotesFile, `release-notes-${packager.platform.buildConfigurationKey}.md`, `release-notes-${packager.platform.name}.md`, `release-notes-${packager.platform.nodeName}.md`, \"release-notes.md\")\n    const releaseNotes = releaseNotesFile == null ? null : await readFile(releaseNotesFile, \"utf-8\")\n    // to avoid undefined in the file, check for null\n    if (releaseNotes != null) {\n      releaseInfo.releaseNotes = releaseNotes\n    }\n  }\n  delete releaseInfo.releaseNotesFile\n  return releaseInfo\n}\n\nfunction isGenerateUpdatesFilesForAllChannels(packager: PlatformPackager<any>) {\n  const value = packager.platformSpecificBuildOptions.generateUpdatesFilesForAllChannels\n  return value == null ? packager.config.generateUpdatesFilesForAllChannels : value\n}\n\n/**\n if this is an \"alpha\" version, we need to generate only the \"alpha\" .yml file\n if this is a \"beta\" version, we need to generate both the \"alpha\" and \"beta\" .yml file\n if this is a \"stable\" version, we need to generate all the \"alpha\", \"beta\" and \"stable\" .yml file\n */\nfunction computeChannelNames(packager: PlatformPackager<any>, publishConfig: PublishConfiguration): Array<string> {\n  const currentChannel: string = (publishConfig as GenericServerOptions).channel || \"latest\"\n  // for GitHub should be pre-release way be used\n  if (currentChannel === \"alpha\" || publishConfig.provider === \"github\" || !isGenerateUpdatesFilesForAllChannels(packager)) {\n    return [currentChannel]\n  }\n\n  switch (currentChannel) {\n    case \"beta\":\n      return [currentChannel, \"alpha\"]\n\n    case \"latest\":\n      return [currentChannel, \"alpha\", \"beta\"]\n\n    default:\n      return [currentChannel]\n  }\n}\n\nfunction getUpdateInfoFileName(channel: string, packager: PlatformPackager<any>, arch: Arch | null): string {\n  const osSuffix = packager.platform === Platform.WINDOWS ? \"\" : `-${packager.platform.buildConfigurationKey}`\n  const archSuffix = (arch != null && arch !== Arch.x64 && packager.platform === Platform.LINUX) ? `-${Arch[arch]}` : \"\"\n  return `${channel}${osSuffix}${archSuffix}.yml`\n}\n\nexport interface UpdateInfoFileTask {\n  readonly file: string\n  readonly info: UpdateInfo\n  readonly publishConfiguration: PublishConfiguration\n\n  readonly packager: PlatformPackager<any>\n}\n\n/** @internal */\nexport async function createUpdateInfoTasks(event: ArtifactCreated, _publishConfigs: Array<PublishConfiguration>): Promise<Array<UpdateInfoFileTask>> {\n  const packager = event.packager\n  const publishConfigs = await getPublishConfigsForUpdateInfo(packager, _publishConfigs, event.arch)\n  if (publishConfigs == null || publishConfigs.length === 0) {\n    return []\n  }\n\n  const outDir = event.target!.outDir\n  const version = packager.appInfo.version\n  const sha2 = new Lazy<string>(() => hashFile(event.file!, \"sha256\", \"hex\"))\n  const isMac = packager.platform === Platform.MAC\n  const createdFiles = new Set<string>()\n  const sharedInfo = await createUpdateInfo(version, event, await getReleaseInfo(packager))\n  const tasks: Array<UpdateInfoFileTask> = []\n  const electronUpdaterCompatibility = packager.platform === Platform.MAC ? (packager.platformSpecificBuildOptions as MacConfiguration).electronUpdaterCompatibility : null\n  for (let publishConfiguration of publishConfigs) {\n    if (publishConfiguration.provider === \"github\" && \"releaseType\" in publishConfiguration) {\n      publishConfiguration = {...publishConfiguration}\n      delete (publishConfiguration as GithubOptions).releaseType\n    }\n\n    let dir = outDir\n    if (publishConfigs.length > 1 && publishConfiguration !== publishConfigs[0]) {\n      dir = path.join(outDir, publishConfiguration.provider)\n    }\n\n    // spaces is a new publish provider, no need to keep backward compatibility\n    let isElectronUpdater1xCompatibility = publishConfiguration.provider !== \"spaces\" && (electronUpdaterCompatibility == null || semver.satisfies(\"1.0.0\", electronUpdaterCompatibility))\n\n    let info = sharedInfo\n    // noinspection JSDeprecatedSymbols\n    if (isElectronUpdater1xCompatibility && packager.platform === Platform.WINDOWS) {\n      info = {\n        ...info,\n      };\n      (info as WindowsUpdateInfo).sha2 = await sha2.value\n    }\n\n    if (event.safeArtifactName != null && publishConfiguration.provider === \"github\") {\n      const newFiles = info.files.slice()\n      newFiles[0].url = event.safeArtifactName\n      info = {\n        ...info,\n        files: newFiles,\n        path: event.safeArtifactName,\n      }\n    }\n\n    for (const channel of computeChannelNames(packager, publishConfiguration)) {\n      if (isMac && isElectronUpdater1xCompatibility && event.file.endsWith(\".zip\")) {\n        // write only for first channel (generateUpdatesFilesForAllChannels is a new functionality, no need to generate old mac update info file)\n        isElectronUpdater1xCompatibility = false\n        await writeOldMacInfo(publishConfiguration, outDir, dir, channel, createdFiles, version, packager)\n      }\n\n      const updateInfoFile = path.join(dir, (publishConfiguration.provider === \"bintray\" ? `${version}_` : \"\") + getUpdateInfoFileName(channel, packager, event.arch))\n      if (createdFiles.has(updateInfoFile)) {\n        continue\n      }\n\n      createdFiles.add(updateInfoFile)\n\n      // artifact should be uploaded only to designated publish provider\n      tasks.push({\n        file: updateInfoFile,\n        info,\n        publishConfiguration,\n        packager,\n      })\n    }\n  }\n  return tasks\n}\n\nasync function createUpdateInfo(version: string, event: ArtifactCreated, releaseInfo: ReleaseInfo): Promise<UpdateInfo> {\n  const customUpdateInfo = event.updateInfo\n  const url = path.basename(event.file!)\n  const sha512 = (customUpdateInfo == null ? null : customUpdateInfo.sha512) || await hashFile(event.file!)\n  const files = [{url, sha512}]\n  const result: UpdateInfo = {\n    version,\n    files,\n    path: url /* backward compatibility, electron-updater 1.x - electron-updater 2.15.0 */,\n    sha512 /* backward compatibility, electron-updater 1.x - electron-updater 2.15.0 */,\n    ...releaseInfo as UpdateInfo,\n  }\n\n  if (customUpdateInfo != null) {\n    // file info or nsis web installer packages info\n    Object.assign(\"sha512\" in customUpdateInfo ? files[0] : result, customUpdateInfo)\n  }\n  return result\n}\n\nexport async function writeUpdateInfoFiles(updateInfoFileTasks: Array<UpdateInfoFileTask>, packager: Packager) {\n  // zip must be first and zip info must be used for old path/sha512 properties in the update info\n  updateInfoFileTasks.sort((a, b) => (a.info.files[0].url.endsWith(\".zip\") ? 0 : 100) - (b.info.files[0].url.endsWith(\".zip\") ? 0 : 100))\n\n  const updateChannelFileToInfo = new Map<string, UpdateInfoFileTask>()\n  for (const task of updateInfoFileTasks) {\n    const key = `${task.file}@${safeStringifyJson(task.publishConfiguration)}`\n    const existingTask = updateChannelFileToInfo.get(key)\n    if (existingTask == null) {\n      updateChannelFileToInfo.set(key, task)\n      continue\n    }\n\n    existingTask.info.files.push(...task.info.files)\n  }\n\n  const releaseDate = new Date().toISOString()\n  await BluebirdPromise.map(updateChannelFileToInfo.values(), async task => {\n    task.info.releaseDate = releaseDate\n    const fileContent = Buffer.from(serializeToYaml(task.info))\n    await outputFile(task.file, fileContent)\n    packager.dispatchArtifactCreated({\n      file: task.file,\n      fileContent,\n      arch: null,\n      packager: task.packager,\n      target: null,\n      publishConfig: task.publishConfiguration,\n    })\n  }, {concurrency: 4})\n}\n\n// backward compatibility - write json file\nasync function writeOldMacInfo(publishConfig: PublishConfiguration, outDir: string, dir: string, channel: string, createdFiles: Set<string>, version: string, packager: PlatformPackager<any>) {\n  const isGitHub = publishConfig.provider === \"github\"\n  const updateInfoFile = (isGitHub && outDir === dir) ? path.join(dir, \"github\", `${channel}-mac.json`) : path.join(dir, `${channel}-mac.json`)\n  if (!createdFiles.has(updateInfoFile)) {\n    createdFiles.add(updateInfoFile)\n    await outputJson(updateInfoFile, {\n      version,\n      releaseDate: new Date().toISOString(),\n      url: computeDownloadUrl(publishConfig, packager.generateName2(\"zip\", \"mac\", isGitHub), packager),\n    }, {spaces: 2})\n\n    packager.info.dispatchArtifactCreated({\n      file: updateInfoFile,\n      arch: null,\n      packager,\n      target: null,\n      publishConfig,\n    })\n  }\n}\n"]}
